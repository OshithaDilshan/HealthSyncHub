<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="assets/tabicon.png" type="image/png">

    <title>Health Sync Hub - User Information</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Josefin Sans', sans-serif;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f4f9;
            display: flex;
            flex-direction: column;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            background-image: url('assets/background.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: #000000;
        }

        .container {
            background-color: white;
            padding: 3rem 4rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            position: relative;
        }


        .container-title {
            text-align: center;
            margin-bottom: 2.5rem;
            /* Removed these two lines:
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #e0e0e0;
            */
        }

        .container-title h2 {
            font-size: 2rem;
            color: #333;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        #userInfoForm {
            width: 100%;
            text-align: center;
            padding: 0;
        }

        .input-row {
            display: flex;
            flex-direction: column;
            gap: 2.5rem;
            margin-bottom: 3rem;
            margin-top: 1.5rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .input-group label {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
        }

        .input-field-container {
            display: flex;
            gap: 0.5rem;
            width: 100%;
            max-width: 300px;
            justify-content: center;
        }

        .input-group input[type="number"],
        .input-group input[type="date"] {
            border: 1px solid #0EFF00;
            border-radius: 4px;
            width: 100%;
            padding: 0.75rem;
            text-align: center;
            font-size: 1rem;
            font-family: 'Josefin Sans', sans-serif;
        }

        .input-group select {
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid #0EFF00;
            border-radius: 4px;
            font-family: 'Josefin Sans', sans-serif;
            width: 80px;
        }

        .button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 3rem;
            gap: 6rem;
            /* Increased from 2rem to 6rem for more spacing */
            width: 100%;
            max-width: 600px;
            /* Increased to accommodate larger gap */
            margin-left: auto;
            margin-right: auto;
            padding: 0 2rem;
            /* Added padding for better spacing */
        }


        #backButton,
        #continueButton {
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
            width: 130px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #backButton {
            background-color: #DAA520;
            color: #fff;
        }

        #continueButton {
            background-color: gray;
            color: #fff;
            cursor: not-allowed;
        }

        #continueButton:enabled {
            background-color: #008000;
            cursor: pointer;
        }

        #backButton:hover {
            background-color: #B8860B;
        }

        #continueButton:enabled:hover {
            background-color: #0c734f;
        }

        footer {
            font-size: 0.875rem;
            line-height: 1.25;
            padding: 1rem;
            text-align: center;
            background-color: #497d59;
            color: #ffffff;
            width: 100%;
        }

        footer p {
            margin: 5px 0;
        }

        @media screen and (min-width: 768px) {
            .input-row {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                gap: 1.5rem;
            }

            .input-group {
                flex: 1;
                min-width: 200px;
                max-width: 300px;
            }
        }

        @media screen and (min-width: 1024px) {
            .input-row {
                flex-wrap: nowrap;
                justify-content: space-around;
            }

            .input-group label {
                font-size: 1.5rem;
            }

            .input-group input[type="number"],
            .input-group input[type="date"],
            .input-group select {
                font-size: 1.125rem;
            }
        }

        @media screen and (max-width: 768px) {
            .container {
                padding: 2rem;
            }

            .container-title h2 {
                font-size: 1.75rem;
            }

            .button-container {
                gap: 4rem;
                /* Reduced gap for medium screens but still larger than original */
                max-width: 100%;
                padding: 0 1.5rem;
            }
        }

        @media screen and (max-width: 360px) {
            .container {
                padding: 1.5rem;
            }

            .container-title h2 {
                font-size: 1.5rem;
            }

            .input-field-container {
                flex-direction: column;
                align-items: center;
            }

            .input-group select {
                width: 100%;
                max-width: 300px;
            }

            .button-container {
                flex-direction: column;
                gap: 2rem;
                /* Increased vertical gap for mobile */
                padding: 0 1rem;
            }

            #backButton,
            #continueButton {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="main-container">
        <div class="container">
            <div class="container-title">
                <h2>Update Your Health Details</h2>
                <p>Keep your health information up to date</p>
            </div>
            <form id="userInfoForm">
                <div class="input-row">
                    <div class="input-group">
                        <label for="birthday">Date of Birth</label>
                        <input 
                            type="date" 
                            id="birthday" 
                            name="birthday" 
                            required
                            class="form-input"
                        >
                        <div class="error-message" id="birthdayError"></div>
                    </div>

                    <div class="input-group">
                        <label for="height">Height</label>
                        <div class="input-field-container">
                            <input 
                                type="number" 
                                id="height" 
                                name="height" 
                                placeholder="Enter height"
                                min="100" 
                                max="250"
                                step="0.1"
                                required
                                class="form-input"
                            >
                            <select 
                                id="heightUnit" 
                                name="heightUnit" 
                                class="form-select"
                            >
                                <option value="cm">cm</option>
                                <option value="ft">ft</option>
                            </select>
                        </div>
                        <div class="error-message" id="heightError"></div>
                    </div>

                    <div class="input-group">
                        <label for="weight">Weight</label>
                        <div class="input-field-container">
                            <input 
                                type="number" 
                                id="weight" 
                                name="weight" 
                                placeholder="Enter weight"
                                min="30" 
                                max="300"
                                step="0.1"
                                required
                                class="form-input"
                            >
                            <select 
                                id="weightUnit" 
                                name="weightUnit" 
                                class="form-select"
                            >
                                <option value="kg">kg</option>
                                <option value="lbs">lbs</option>
                            </select>
                        </div>
                        <div class="error-message" id="weightError"></div>
                    </div>
                </div>

                <div class="input-group">
                    <label for="healthGoals">Health Goals (Optional)</label>
                    <textarea 
                        id="healthGoals" 
                        name="healthGoals" 
                        placeholder="E.g., Lose weight, build muscle, improve endurance..."
                        rows="3"
                        class="form-textarea"
                    ></textarea>
                    <div class="error-message" id="healthGoalsError"></div>
                </div>

                <div class="button-container">
                    <button type="button" id="backButton" class="btn btn-secondary" onclick="window.history.back()">
                        Back
                    </button>
                    <button type="submit" id="saveButton" class="btn btn-primary">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <footer>
        <p>&copy; 2024 Health Sync Hub. All rights reserved.</p>
        <p>Email: support@mealplanningapp.com | Phone: +94 123 456 789</p>
    </footer>

    <script>
        // DOM Elements
        const userInfoForm = document.getElementById('userInfoForm');
        const birthdayInput = document.getElementById('birthday');
        const heightInput = document.getElementById('height');
        const weightInput = document.getElementById('weight');
        const heightUnitSelect = document.getElementById('heightUnit');
        const weightUnitSelect = document.getElementById('weightUnit');
        const healthGoalsInput = document.getElementById('healthGoals');
        const saveButton = document.getElementById('saveButton');

        
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'login.html';
            throw new Error('No authentication token found');
        }

        
        const today = new Date();
        const minDate = new Date();
        minDate.setFullYear(today.getFullYear() - 120);
        
        
        function formatDate(date) {
            if (!date) return '';
            const d = new Date(date);
            return d.toISOString().split('T')[0];
        }

        
        function cmToFeet(cm) {
            return (cm / 30.48).toFixed(2);
        }

        
        function feetToCm(feet) {
            return Math.round(feet * 30.48);
        }

        
        function kgToLbs(kg) {
            return (kg * 2.20462).toFixed(2);
        }

        
        function lbsToKg(lbs) {
            return (lbs / 2.20462).toFixed(2);
        }

        
        function showError(field, message) {
            const errorElement = document.getElementById(`${field}Error`);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        
        function clearError(field) {
            const errorElement = document.getElementById(`${field}Error`);
            if (errorElement) {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            }
        }

        
        function validateForm() {
            let isValid = true;

            
            if (!birthdayInput.value) {
                showError('birthday', 'Date of birth is required');
                isValid = false;
            } else {
                const dob = new Date(birthdayInput.value);
                if (dob > today) {
                    showError('birthday', 'Date of birth cannot be in the future');
                    isValid = false;
                } else if (dob < minDate) {
                    showError('birthday', 'Please enter a valid date');
                    isValid = false;
                } else {
                    clearError('birthday');
                }
            }

            
            if (!heightInput.value) {
                showError('height', 'Height is required');
                isValid = false;
            } else {
                const height = parseFloat(heightInput.value);
                if (heightUnitSelect.value === 'cm' && (height < 100 || height > 250)) {
                    showError('height', 'Height must be between 100cm and 250cm');
                    isValid = false;
                } else if (heightUnitSelect.value === 'ft' && (height < 3.28 || height > 8.2)) {
                    showError('height', 'Height must be between 3.28ft and 8.2ft');
                    isValid = false;
                } else {
                    clearError('height');
                }
            }

            
            if (!weightInput.value) {
                showError('weight', 'Weight is required');
                isValid = false;
            } else {
                const weight = parseFloat(weightInput.value);
                if (weightUnitSelect.value === 'kg' && (weight < 30 || weight > 300)) {
                    showError('weight', 'Weight must be between 30kg and 300kg');
                    isValid = false;
                } else if (weightUnitSelect.value === 'lbs' && (weight < 66 || weight > 661)) {
                    showError('weight', 'Weight must be between 66lbs and 661lbs');
                    isValid = false;
                } else {
                    clearError('weight');
                }
            }

            return isValid;
        }

        
        async function fetchUserProfile() {
            try {
                const response = await fetch('http://localhost:5000/api/user/profile/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch profile');
                }

                const data = await response.json();
                
                if (data && data.data) {
                    const profile = data.data;
                    
                    
                    if (profile.dateOfBirth) {
                        birthdayInput.value = formatDate(profile.dateOfBirth);
                    }
                    
                    if (profile.height) {
                        heightInput.value = profile.height;
                        heightUnitSelect.value = 'cm';
                    }
                    
                    if (profile.weight) {
                        weightInput.value = profile.weight;
                        weightUnitSelect.value = 'kg';
                    }
                    
                    if (profile.healthGoals) {
                        healthGoalsInput.value = profile.healthGoals;
                    }
                }
                
            } catch (error) {
                console.error('Error fetching profile:', error);
                alert('Failed to load profile. ' + error.message);
            } finally {
                
                saveButton.disabled = false;
                saveButton.textContent = 'Save Changes';
            }
        }

        
        function handleUnitChange() {
            
            if (heightInput.value) {
                const height = parseFloat(heightInput.value);
                if (heightUnitSelect.value === 'ft') {
                    // Convert cm to ft
                    heightInput.value = cmToFeet(height);
                } else {
                    
                    heightInput.value = feetToCm(height);
                }
            }
            
            
            if (weightInput.value) {
                const weight = parseFloat(weightInput.value);
                if (weightUnitSelect.value === 'lbs') {
                    
                    weightInput.value = kgToLbs(weight);
                } else {
                    
                    weightInput.value = lbsToKg(weight);
                }
            }
        }


        
        async function saveProfile(event) {
            event.preventDefault();
            
            if (!validateForm()) {
                return;
            }
            
            try {
                
                saveButton.disabled = true;
                saveButton.textContent = 'Saving...';
                
                
                let height = parseFloat(heightInput.value);
                let weight = parseFloat(weightInput.value);
                
                if (heightUnitSelect.value === 'ft') {
                    height = feetToCm(height);
                }
                
                if (weightUnitSelect.value === 'lbs') {
                    weight = lbsToKg(weight);
                }
                
                const profileData = {
                    dateOfBirth: birthdayInput.value,
                    height: height,
                    weight: weight,
                    healthGoals: healthGoalsInput.value.trim()
                };
                
                const response = await fetch('http://localhost:5000/api/user/profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(profileData)
                });
                
                const responseData = await response.json();
                
                if (!response.ok) {
                    throw new Error(responseData.message || 'Failed to save profile');
                }
                
                
                alert('Profile updated successfully!');
                window.location.href = 'dashboard.html'; 
                
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Failed to save profile. ' + (error.message || 'Please try again.'));
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Save Changes';
            }
        }

        
        document.addEventListener('DOMContentLoaded', () => {
            
            birthdayInput.max = today.toISOString().split('T')[0];
            birthdayInput.min = minDate.toISOString().split('T')[0];
            
            
            fetchUserProfile();
            
            
            birthdayInput.addEventListener('blur', validateForm);
            heightInput.addEventListener('input', () => clearError('height'));
            weightInput.addEventListener('input', () => clearError('weight'));
            
            
            heightUnitSelect.addEventListener('change', handleUnitChange);
            weightUnitSelect.addEventListener('change', handleUnitChange);
            
            
            userInfoForm.addEventListener('submit', saveProfile);
        });
    </script>
</body>

</html>